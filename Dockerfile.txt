# Root-level Dockerfile for Mercur (backend)
FROM node:20-alpine

# Sistem bağımlılığı
RUN apk add --no-cache libc6-compat

# Kök çalışma dizini
WORKDIR /app

# Tüm monorepo'yu kopyala
COPY . .

# Yarn Berry'yi (Corepack) etkinleştir ve bağımlılıkları kur
RUN corepack enable && corepack prepare yarn@stable --activate
RUN yarn install --immutable || yarn install

# Prod ortam
ENV NODE_ENV=production

# Backend dizinine geç ve servis portunu aç
WORKDIR /app/apps/backend
EXPOSE 9000

# Sunucuyu başlat (Railway'in verdiği $PORT'u kullan)
CMD ["sh","-c","yarn medusa start -p ${PORT:-9000}"]
