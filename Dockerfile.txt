# ---- base ----
FROM node:20-bookworm-slim AS base
WORKDIR /app
ENV NODE_ENV=development
# Node 20 zaten corepack ile geliyor ama versiyonu sabitleyelim:
RUN corepack enable && corepack prepare yarn@1.22.21 --activate

# ---- deps (install) ----
FROM base AS deps
COPY package.json yarn.lock ./
# monorepo ise install öncesi workspace package.json'larını da kopyalamak cache için iyi olur
COPY apps ./apps
COPY packages ./packages
# sadece lockfile'a göre kur (CI dostu)
RUN --mount=type=cache,target=/root/.cache/yarn \
    yarn install --frozen-lockfile

# ---- build ----
FROM base AS build
COPY --from=deps /app /app
RUN yarn build

# ---- run ----
FROM node:20-bookworm-slim AS run
WORKDIR /app
ENV NODE_ENV=production
RUN corepack enable && corepack prepare yarn@1.22.21 --activate
# Sadece gerekenleri kopyala (dist + prod deps için node_modules yeniden kurulabilir)
COPY package.json yarn.lock ./
COPY --from=build /app/dist ./dist
# Prod bağımlılıkları (yoksa atla)
RUN --mount=type=cache,target=/root/.cache/yarn \
    yarn install --frozen-lockfile --production

EXPOSE 3000
# Uygulamanın entrypoint'i neyse ona göre güncelle
CMD ["node", "dist/index.js"]
